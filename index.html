<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Materiais</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container my-4">
        <!-- Cadastro de Material -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Cadastro de Material</h5>
            </div>
            <div class="card-body">
                <form id="formCadastro" onsubmit="cadastrarMaterial(event)">
                    <div class="mb-3">
                        <label class="form-label">Código</label>
                        <input type="text" id="codigo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <input type="text" id="descricao" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantidade" class="form-control" min="0" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                </form>
            </div>
        </div>
        
        <!-- Lista de Materiais -->
        <div class="card mt-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Materiais Cadastrados</h5>
                <button onclick="carregarMateriais()" class="btn btn-light btn-sm">
                    Atualizar Lista
                </button>
            </div>
            <div class="card-body">
                <div id="listaMateriais"></div>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzx3_VG69mlsJ48gHH6ZupWLDzYWrcMu33a0Hx5_4AlUhw-dPS-RgmzxUXSWhWEwXIJ/exec';

        // Função para carregar dados
        async function carregarMateriais() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                atualizarListaMateriais(data);
            } catch (erro) {
                console.error('Erro ao carregar materiais:', erro);
                document.getElementById('listaMateriais').innerHTML = 
                    `<div class="alert alert-danger">Erro ao carregar materiais: ${erro.message}</div>`;
            }
        }

        // Função para cadastrar
        async function cadastrarMaterial(event) {
            event.preventDefault();
            
            const codigo = document.getElementById('codigo').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const quantidade = document.getElementById('quantidade').value;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        codigo,
                        descricao,
                        quantidade
                    })
                });

                const data = await response.json();
                
                if (data.status === "success") {
                    alert('Material cadastrado com sucesso!');
                    document.getElementById('formCadastro').reset();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await carregarMateriais();
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
            } catch (erro) {
                console.error('Erro no cadastro:', erro);
                alert(`Erro ao cadastrar: ${erro.message}`);
            }
        }

        // Função para atualizar lista
        function atualizarListaMateriais(materiais) {
            const lista = document.getElementById('listaMateriais');
            
            if (!materiais || materiais.length === 0) {
                lista.innerHTML = '<div class="alert alert-info">Nenhum material cadastrado.</div>';
                return;
            }

            const html = materiais.map(material => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">Código: ${material.codigo}</h5>
                        <p class="card-text">
                            <strong>Descrição:</strong> ${material.descricao}<br>
                            <strong>Quantidade:</strong> ${material.quantidade}
                        </p>
                    </div>
                </div>
            `).join('');

            lista.innerHTML = html;
        }

        // Carrega dados iniciais
        document.addEventListener('DOMContentLoaded', carregarMateriais);

        // Recarrega a cada 30 segundos
        setInterval(carregarMateriais, 30000);
    </script>
</body>
</html>
